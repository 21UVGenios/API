trigger: none

resources:
  pipelines:
    - pipeline: buildPipeline  
      source: buildPipeline    
      trigger:
        branches:
          include:
            - dev
            - release
            - main
            - prod

pool:
  name: SegAPI

variables:
  buildConfiguration: 'Release'
  RESOURCE_GROUP: 'UVGeniosFunction_group' 
  FUNCTION_APP_NAME: 'UVGeniosFunction'  

stages:
- stage: Release
  jobs:
  - job: PublishJob
    steps:
      - checkout: self
        displayName: 'üì• Clonar el repositorio'

      - download: buildPipeline
        artifact: functionapp
        displayName: '‚¨áÔ∏è Descargar artefactos desde buildPipeline'

      - task: UseDotNet@2
        displayName: 'üß∞ Instalar .NET 8 SDK'
        inputs:
          packageType: 'sdk'
          version: '8.0.x'
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - script: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az --version
        displayName: "Instalar Azure CLI"

      - task: AzureCLI@2
        displayName: 'üöÄ Desplegar Azure Function App con ZIP'
        inputs:
          azureSubscription: 'UVGeniosServiceConFun'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            echo "üîç Buscando ZIP de publicaci√≥n..."
            ZIP_FILE=$(find "$(Pipeline.Workspace)/buildPipeline" -name "*.zip" | head -1)
            echo "üì¶ Archivo encontrado: $ZIP_FILE"
            echo "üöÄ Desplegando a Azure Function App: $FUNCTION_APP_NAME"

            az functionapp deployment source config-zip \
              --resource-group $RESOURCE_GROUP \
              --name $FUNCTION_APP_NAME \
              --src "$ZIP_FILE" \
              --build-remote false
