trigger: none 

resources:
  pipelines:
    - pipeline: buildPipeline  
      source: buildPipeline    
      trigger:
        branches:
          include:
            - dev
            - release
            - main
            - prod

pool:
  name: SegAPI

variables:
  buildConfiguration: 'Release'

stages:
- stage: Release
  jobs:
  - job: PublishJob
    steps:
      - checkout: self
        displayName: 'üì• Clonar el repositorio'

      - download: buildPipeline
        artifact: functionapp
        displayName: '‚¨áÔ∏è Descargar artefactos desde buildPipeline'

      - task: AzureCLI@2
        displayName: 'üöÄ Desplegar Function App con az CLI'
        inputs:
          azureSubscription: 'UVGeniosServiceConFun'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            echo "üì¶ Buscando archivo ZIP..."
            ZIP_FILE=$(find "$(Pipeline.Workspace)/buildPipeline/functionapp" -name "*.zip" | head -1)
      
            if [ -z "$ZIP_FILE" ]; then
              echo "‚ùå No se encontr√≥ ning√∫n archivo .zip para desplegar."
              exit 1
            fi
      
            echo "‚úÖ Archivo ZIP encontrado: $ZIP_FILE"
      
            echo "üöÄ Desplegando Azure Function..."
            az functionapp deployment source config-zip \
              --name UVGeniosFunction \
              --resource-group UVGeniosFunction_group \
              --src "$ZIP_FILE"
