trigger: none 

resources:
  pipelines:
    - pipeline: buildPipeline  
      source: buildPipeline    
      trigger:
        branches:
          include:
            - dev
            - release
            - main
            - prod

pool:
  name: SegAPI

variables:
  buildConfiguration: 'Release'

stages:
- stage: Release
  jobs:
  - job: PublishJob
    steps:
      - download: buildPipeline
        artifact: functionapp
        displayName: '‚¨áÔ∏è Descargar artefactos desde buildPipeline'

      - task: AzureCLI@2
        displayName: 'üöÄ Desplegar Function App con az CLI'
        inputs:
          azureSubscription: 'UVGeniosServiceConFun'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            echo "üì¶ Buscando archivo ZIP..."
            ZIP_FILE=$(find $(System.DefaultWorkingDirectory)/functionapp -name "*.zip" | head -1)
  
            if [ -z "$ZIP_FILE" ]; then
              echo "‚ùå No se encontr√≥ ning√∫n archivo .zip para desplegar."
              exit 1
            fi
  
            echo "üìÑ Archivo encontrado: $ZIP_FILE"
  
            echo "üöÄ Iniciando despliegue..."
            az functionapp deployment source config-zip \
              --resource-group $RESOURCE_GROUP \
              --name $FUNCTION_APP_NAME \
              --src "$ZIP_FILE" \
              --build-remote false
  
            echo "‚úÖ Despliegue completado."
        env:
          RESOURCE_GROUP: 'UVGeniosFunction_group'
          FUNCTION_APP_NAME: 'UVGeniosFunction' 
