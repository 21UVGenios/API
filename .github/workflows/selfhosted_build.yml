trigger:
  branches:
    include:
      - dev
      - release
      - main
      - prod

pool:
  name: "SegAPI"

variables:
  buildConfiguration: 'Release'

steps:
  - task: UseDotNet@2
    displayName: 'ğŸ§° Instalar .NET 8 SDK'
    inputs:
      packageType: 'sdk'
      version: '8.0.x'
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: NuGetToolInstaller@1
    displayName: 'ğŸ“¦ Instalar NuGet CLI'

  - task: NuGetAuthenticate@1
    displayName: 'ğŸ” AutenticaciÃ³n con Azure Artifacts'

  - script: |
      cp src/app/nuget.config .
    displayName: 'ğŸ“‹ Copiar nuget.config a raÃ­z'

  - script: |
      dotnet restore src/app/app.csproj --configfile nuget.config
    displayName: 'ğŸ”§ Restaurar dependencias'

  - script: |
      dotnet build src/app/app.csproj --configuration $(buildConfiguration) --no-restore
    displayName: 'ğŸ—ï¸ Compilar soluciÃ³n'

  - script: |
      dotnet publish src/app/app.csproj --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/functionapp --no-build
    displayName: 'ğŸš€ Publicar Azure Function'

  - script: |
      ls -la $(Build.ArtifactStagingDirectory)/functionapp
      cat $(Build.ArtifactStagingDirectory)/functionapp/host.json
    displayName: 'ğŸ‘€ Ver contenido publicado'

  - task: PublishBuildArtifacts@1
    displayName: 'ğŸ“¤ Publicar artefactos para release'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/functionapp'
      ArtifactName: 'functionapp'
      publishLocation: 'Container'

  - script: |
      dotnet pack src/app/app.csproj --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/nuget
    displayName: 'ğŸ“¦ Empaquetar NuGet'

  - script: |
      dotnet nuget push "$(Build.ArtifactStagingDirectory)/nuget/*.nupkg" --source "UVGenios" --api-key "az" --skip-duplicate
    displayName: 'â¬†ï¸ Publicar paquete NuGet en UVGenios'
