trigger: none 

pr:
  branches:
    include:
      - dev
      - release
  autoCancel: false  
  drafts: false 

pool:
  name: SegAPI

variables:
  buildConfiguration: 'Release'

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
      - checkout: self
        displayName: 'ğŸ“¥ Clonar el repositorio'

      - task: NuGetToolInstaller@1
        displayName: 'ğŸ”§ Instalar NuGet'
      
      - task: NuGetCommand@2
        displayName: 'ğŸ› ï¸ Restaurar paquetes NuGet'
        inputs:
          command: 'restore'
          restoreSolution: '**/*.sln'
          feedsToUse: 'config'
          nugetConfigPath: 'src/app/nuget.config'

      - task: NuGetAuthenticate@1
        displayName: 'ğŸ”‘ Authenticate with Azure Artifacts'

      - task: UseDotNet@2
        displayName: 'ğŸ§° Instalar .NET 8 SDK'
        inputs:
          packageType: 'sdk'
          version: '8.0.x'
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - script: |
          dotnet restore src/app/app.csproj
          dotnet restore src/tests/appTests.csproj
        displayName: 'ğŸ› ï¸ Restaurar dependencias'

      - script: dotnet build src/**/*.csproj --no-restore --configuration $(buildConfiguration)
        displayName: 'ğŸ§ª Compilar soluciÃ³n'

      - script: |
          dotnet test src/**/*Tests.csproj --no-build --verbosity normal || echo "No tests found"
        displayName: 'âœ… Ejecutar pruebas (si existen)'

      - script: |
          dotnet pack src/**/*.csproj --no-build -c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)/nuget /p:Version=1.0.$(Build.BuildId)
        displayName: 'ğŸ“¦ Empaquetar NuGet'

      - script: |
          ls -la $(Build.ArtifactStagingDirectory)/nuget
        displayName: 'ğŸ” Verificar paquetes NuGet generados'

      - task: PublishBuildArtifacts@1
        displayName: 'ğŸ“¤ Publicar artefactos'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/nuget'
          ArtifactName: 'nuget'
          publishLocation: 'Container'
