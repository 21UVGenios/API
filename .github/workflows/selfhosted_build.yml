trigger:
  branches:
    include:
      - dev
      - release

pool:
  name: SegAPI

variables:
  buildConfiguration: 'Release'

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
      - checkout: self
        displayName: 'üì• Clonar el repositorio'

      - task: UseDotNet@2
        displayName: 'üß∞ Instalar .NET 6 LTS SDK'
        inputs:
          packageType: 'sdk'
          version: '6.0.x'
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - script: dotnet restore src/**/*.csproj
        displayName: 'üõ†Ô∏è Restaurar dependencias'

      - script: dotnet build src/**/*.csproj --no-restore --configuration $(buildConfiguration)
        displayName: 'üß™ Compilar soluci√≥n'

      - script: |
          dotnet test src/**/*Tests.csproj --no-build --verbosity normal || echo "No tests found"
        displayName: '‚úÖ Ejecutar pruebas (si existen)'

      - script: dotnet pack src/**/*.csproj --no-build -c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)/nuget
        displayName: 'üì¶ Empaquetar NuGet'

      - script: |
          dotnet nuget push "$(Build.ArtifactStagingDirectory)/nuget/*.nupkg" \
            --source "https://pkgs.dev.azure.com/UVGenios/_packaging/UVGenios/nuget/v3/index.json" \
            --api-key az
        displayName: '‚¨ÜÔ∏è Publicar paquete NuGet a feed UVGenios'
        env:
          VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: '{"endpointCredentials": [{"endpoint":"https://pkgs.dev.azure.com/$(System.Organization)/_packaging/UVGenios/nuget/v3/index.json","password":"$(System.AccessToken)"}]}'
